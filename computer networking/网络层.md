---
typora-copy-images-to: ./计算机网络1.resources
---

[TOC]

# 网络层

 <img src="计算机网络1.resources/image-20200307104232421.png" alt="image-20200307104232421" style="zoom: 67%;" />

## 网络层提供的服务

网络层主要负责在不同网络之间 尽力基于IP地址转发数据包，不负责丢失重传。（**数据转发**）

网络层为传输层提供两种服务

* 虚电路：建立一条虚拟的连接
* 数据报：提供无连接的、尽最大能力交付的数据报，发送分组不需要建立连接，不保证服务质量

## 网络互联的设备



<img src="计算机网络1.resources/image-20200311002508249.png" alt="image-20200311002508249" style="zoom:50%;" />

现在网关就是路由器的借口地址，一般是第一个地址和最后一个地址

<img src="计算机网络1.resources/image-20200307104702360.png" alt="image-20200307104702360" style="zoom: 50%;" />

## IP地址



<img src="计算机网络1.resources/image-20200311101755507.png" alt="image-20200311101755507" style="zoom:50%;" />

<img src="计算机网络1.resources/image-20200311103341750.png" alt="image-20200311103341750" style="zoom:50%;" />

所以A类地址一共有256x256x256个，B类地址256x256个，C类地址256个

<img src="计算机网络1.resources/image-20200311104606188.png" alt="image-20200311104606188" style="zoom:50%;" />

<img src="计算机网络1.resources/image-20200311105024813.png" alt="image-20200311105024813" style="zoom:50%;" />

A：0xxxxxxx-：1 - 127

B：10xxxxxx：128.1 - 191.255

C：110xxxxx：192.0.1 - 233.255.255

127.0.0.1是本地回环地址；255是8个全1

<img src="计算机网络1.resources/image-20200311105919899.png" alt="image-20200311105919899" style="zoom:50%;" />

### 子网掩码

<img src="计算机网络1.resources/image-20200311134157953.png" alt="image-20200311134157953" style="zoom:50%;" />

**子网掩码**表示了网络部分和主机部分

假设有IP地址	192.168.80.123 

​         子网掩码  255.255.255.0

​          网关	    192.168.80.1 

另一个地址是    192.168.90.125

通过与子网掩码“与”操作后，两个地址的网络部分不一样，所以位于两个不同的网段，不能直接ping通，先访问出口网管；但如果子网掩码为255.255.0.0，则两个地址的网络部分一样，所以位于相同的网段，网络联通

### 子网划分

方法：将主机部分的一部分变成网络部分

子网掩码的1每往后面挪一位，每个子网地址数目变为原来子网的1/2，子网（网段）数为原来的2倍 

<img src="计算机网络1.resources/image-20200311141549886.png" alt="image-20200311141549886" style="zoom:50%;" />

子网划分实例，网关一般是第一个地址，最后一个地址是广播地址 

<img src="计算机网络1.resources/image-20200311142811689.png" alt="image-20200311142811689" style="zoom:50%;" />

点到点的网络子网掩码是255.255.255.252，只有最后两位是00，2<sup>2</sup>-2=2

**变长子网的划分**：每个网段的子网掩码不同，在坐标轴上每除2，便分成两段。

通过画坐标轴，每划分一次，都变成原来的一半，段长为地址数目

<img src="计算机网络1.resources/image-20200311183642402.png" alt="image-20200311183642402" style="zoom:50%;" />

等分的时候，段长相同；不等分时，段长不同；

### 超网

<img src="计算机网络1.resources/image-20200311191838669.png" alt="image-20200311191838669" style="zoom:50%;" />

图中A和B两个处于不同的网段，不能直接通信，更改子网掩码255.255.254.0就能把两个网段合并

<img src="计算机网络1.resources/image-20200311192544925.png" alt="image-20200311192544925" style="zoom:50%;" />

子网掩码合并规律

判断两个网段能不能进行合并，主机号除4，如果余数是一对，就可以合并

<img src="计算机网络1.resources/image-20200311193011365.png" alt="image-20200311193011365" style="zoom:50%;" />

## 数据传输过程

**传输层**负责将数据分段编号，再进行传输，**网络层**为其加上目标地址和源地址，**数据链路层**路过一个转发装置将下一跳的MAC地址重新封装；

<img src="计算机网络1.resources/image-20200307110607436.png" alt="image-20200307110607436" style="zoom:67%;" />

> 正常情况下，路由器肯定不会修改数据包的源地址和目标地址，只是路由器启用NAT功能后,会将IP地址和TCP端口绑定重新定义一个出口IP地址和新的端口

首先使用自己的子网掩码判断自己和目标地址在哪个网段。如果是同一个网段，通过 *ARP协议广播* 解析目标地址的MAC地址；如果不在同一个网段，下一跳的MAC地址是网关地址，如果没有网关地址就不能跨网传输。但数据帧的每一跳都会重新封装下一跳的数据帧，表示下一跳去哪

**网关**即一个网络连接另一个网络的关口，数据出口，要出去数据必须要知道或经过的地址

交换机的功能：存储转发仅能根据MAC地址，所以是二层设备

<img src="计算机网络1.resources/image-20200307175352963.png" alt="image-20200307175352963" style="zoom:50%;" />

>  病毒可以在网络设备上运行么？
>
> 病毒是应用程序，传输过程中在传输层分成不同的数据段，无法正常工作

## 网络层协议

<img src="计算机网络1.resources/image-20200307181350798.png" alt="image-20200307181350798" style="zoom:50%;" />

ARP——IP——ICMP/IGMP，一个为一个提供服务

### ARP

地址解析协议，即*ARP*（Address **Resolution** Protocol）。在一个网段内，通过广播获得目标IP地址的MAC地址对应表。

通过使用arp -a查看

<img src="计算机网络1.resources/image-20200307184534088.png" alt="image-20200307184534088" style="zoom:50%;" />

> ARP欺骗：其实是另外一台计算机充当“黑中介”，再两台物理机之间充当一个交换机。ARP广播找目标IP地址的MAC地址，欺骗者收到广播帧会返回一个假MAC地址对应表，使其发给自己 

### ICMP

网际控制报文协议（Internet Control Message Protocol）。常用ping命令

<img src="计算机网络1.resources/image-20200307191825235.png" alt="image-20200307191825235" style="zoom:50%;" />

### IGMP

网际组管理协议（Internet Group Management Protocol），协议配置在路由器的接口上，周期性扫描网段，查看那些计算机绑定多播地址，确定是否转发多播信号。

IGMP报文实现组成员管理功能，IGMP报文封装在IP报文中。

MAC帧类型分成单播帧（点到点）、组播（又叫多播）、广播

## IP数据包

<img src="计算机网络1.resources/image-20200309114234100.png" alt="image-20200309114234100" style="zoom:50%;" />

<img src="计算机网络1.resources/image-20200309121205347.png" alt="image-20200309121205347" style="zoom:50%;" />

每一行是4个字节32位，一共5行，所以IP首部固定长度是20个字节。

1. 版本：4位，哪个版本的TCP/IP协议，IPv4 or IPv6
2. 首部长度：4位，就是首部是多少个字节。一行32位=4byte，固定部分一共5行，固定首部一共20byte，由于首部长度那一栏是4位，用0101表示20byte，那么最大可以是1111，所以首部最大到15*4=60byte
3. 区分服务：标记为优先服务
4. 总长度：整个IP数据包的长度，即字节数，占16位，用这个长度来计数，可以最高容纳2<sup>16</sup>-1=65535字节，MAC帧最长也才1500字节，需要将**数据包分片**传输，片上最多传1480个字节。【计算机怎么计数呢，只能通过0-1二进制，位数限制了计数大小】
5. 标识：同一个数据报的各个分片的标识是一样的
6. 标志：占3位，目前只有两位有意义，最后一位是1表示还有分片，0表示最后一个分片；第二位为0表示可以分片

<img src="计算机网络1.resources/image-20200310112803320.png" alt="image-20200310112803320" style="zoom:50%;" />

7. 生存时间（TTL）：过一个路由器减1
8. 协议号：ICMP协议号是1，IGMP 2，TCP 6，UDP 17，IPv6 41，OSPF 89

<img src="计算机网络1.resources/image-20200310123557200.png" alt="image-20200310123557200" style="zoom:50%;" />

## IP协议

IP协议：能够自动学习路由表的协议的统称

### 静态路由

静态路由需要网管配置路由器，所有没有直连网络下一跳的地址 

### 动态路由

#### RIP协议

RIP协议（Routing Information Protocol,路由信息协议）：路由器广播RIP数据包，说明自己连接的网段和跳数，以跳数为权重；周期性广播路由表 ，最大跳数15，30秒更新一次（随时得知连接状态）

<img src="计算机网络1.resources/image-20200310143916332.png" alt="image-20200310143916332" style="zoom:50%;" />

#### OSPF协议

OSPF协议，开放最短路协议，是以带宽为权重。支持多区域，触发式更新

<img src="计算机网络1.resources/image-20200315100404892.png" alt="image-20200315100404892" style="zoom:50%;" />

路由器采用OSPF协议采用三个表：邻居表（10s hello包）、链路状态表、计算路由表（狄杰斯特拉）

#### BGP协议

BGP协议，外部网关协议。连接各个自治系统的路由协议

<img src="计算机网络1.resources/image-20200315101726928.png" alt="image-20200315101726928" style="zoom:60%;" />

每个自治系统有个BGP发言人

<img src="计算机网络1.resources/image-20200315102122933.png" alt="image-20200315102122933" style="zoom:50%;" />

## VPN

虚拟专用网络

<img src="计算机网络1.resources/image-20200315105037296.png" alt="image-20200315105037296" style="zoom:45%;" />

一个公网IP想要访问私网地址，需要将私网目的地址和私网源地址封进数据包，目的地址是连在外网的内网服务器上，RAS（远程访问服务器）收到数据包，露出私网目的地址和私网源地址，进行内网的数据访问。

## 网络地址转换NAT

PAT 端口地址转换

> 举个例子，客户端172.18.250.6和百度服务器202.108.22.5通信，172.18.250.6发送数据时，先转换为219.155.6.240:1723（任意>1024的随机端口），然后再利用这个身份发送数据给百度服务器，然后百度服务器回应数据并发送给219.155.6.240:1723，NAT网关检查自己的关联表，意识到这是自己地私网中172.18.250.6的数据包，然后把这个数据发送给客户端 
>

